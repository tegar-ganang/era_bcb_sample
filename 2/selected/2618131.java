package ejb.bprocess.OAIPMH;

import javax.jms.*;
import javax.ejb.*;
import java.io.*;
import java.net.*;
import javax.naming.*;

/**
 * Created Jul 5, 2005 1:08:21 PM
 * Code generated by the Sun ONE Studio EJB Builder
 * @author administrator
 */
public class Oaipmh_MsgBean implements javax.ejb.MessageDrivenBean, javax.jms.MessageListener {

    private transient javax.ejb.MessageDrivenContext context;

    private ejb.bprocess.OAIPMH.AutoHarvesterSessionHome home;

    QueueConnection conn;

    QueueSession session;

    Queue que;

    QueueConnectionFactory qcf;

    InitialContext iniCtx;

    /**
     * @see javax.ejb.MessageDrivenBean#setMessageDrivenContext(javax.ejb.MessageDrivenContext)
     */
    public void setMessageDrivenContext(javax.ejb.MessageDrivenContext aContext) {
        context = aContext;
    }

    /**
     * See section 15.4.4 of the EJB 2.0 specification
     */
    public void ejbCreate() {
        try {
            setupPTP();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void setupPTP() throws JMSException, NamingException {
        iniCtx = new InitialContext();
        Object tmp = iniCtx.lookup("ConnectionFactory");
        qcf = (QueueConnectionFactory) tmp;
        conn = qcf.createQueueConnection();
        session = conn.createQueueSession(false, QueueSession.AUTO_ACKNOWLEDGE);
        conn.start();
    }

    /**
     * @see javax.jms.MessageListener#onMessage(javax.jms.Message)
     */
    public void onMessage(javax.jms.Message aMessage) {
        try {
            String urlStr = "http://203.197.20.2:8080/newgenlibctxt/oai2.0?verb=ListRecords&resumptionToken=100_marc";
            java.net.URL url = new java.net.URL(urlStr);
            java.net.URLConnection urlCon = url.openConnection();
            urlCon.setDoInput(true);
            urlCon.connect();
            InputStream is = urlCon.getInputStream();
            org.jdom.input.SAXBuilder sb = new org.jdom.input.SAXBuilder();
            org.jdom.Document doc = sb.build(is);
            String xmlstr = (new org.jdom.output.XMLOutputter()).outputString(doc);
            doc = null;
            sb = null;
            java.util.Vector vec = new java.util.Vector();
        } catch (Exception e) {
            e.printStackTrace();
        }
        try {
            TextMessage tm = (TextMessage) aMessage;
            String text = tm.getText() + "processed by: message bean on july 13" + hashCode();
            Queue dest = (Queue) aMessage.getJMSReplyTo();
            sendReply(text, dest);
        } catch (Throwable t) {
            t.printStackTrace();
        }
    }

    private void sendReply(String text, Queue dest) throws JMSException {
        QueueSender sender = session.createSender(dest);
        TextMessage tm = session.createTextMessage(text);
        sender.send(tm);
        sender.close();
    }

    /**
     * @see javax.ejb.MessageDrivenBean#ejbRemove()
     */
    public void ejbRemove() {
        try {
            if (session != null) {
                session.close();
            }
            if (conn != null) {
                conn.close();
            }
        } catch (JMSException e) {
            e.printStackTrace();
        }
    }
}
